<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>üååüìö DzenWiki Explorer</title>
  <meta name="description" content="–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞ –≤–∏–¥–µ–æ –≤ –î–∑–µ–Ω–µ –∏ —Å—Ç–∞—Ç–µ–π –≤ –í–∏–∫–∏–ø–µ–¥–∏–∏.">
  <link rel="manifest" href="/manifest.json">
  <link rel="icon" href="icon-192.png">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.min.js"></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://apis.google.com/js/api.js" async defer></script>
  <style>
    /* (–≤–∞—à CSS –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –∫–æ–¥–∞) */
  </style>
</head>
<body class="mode-dzen">
  <!-- (–≤–∞—à HTML –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –∫–æ–¥–∞) -->
  <div class="container">
    <header>
      <div class="logo" id="logo"><i class="fas fa-blog"></i> Dzen Explorer</div>
      <div class="controls" id="dzenControls">
        <button class="btn" id="toggleModeBtn"><i class="fas fa-exchange-alt"></i> –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ä–µ–∂–∏–º</button>
        <button class="btn" id="hideBtn"><i class="fas fa-user-secret"></i> –°–∫—Ä—ã—Ç—å</button>
        <!-- –ö–Ω–æ–ø–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å -->
      </div>
    </header>
    <!-- (–æ—Å—Ç–∞–ª—å–Ω–æ–π HTML) -->
    <div id="dzenMode">
      <!-- (–≤–∞—à HTML –î–∑–µ–Ω) -->
      <div id="preview3d"></div> <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è 3D -->
    </div>
    <!-- (–æ—Å—Ç–∞–ª—å–Ω–æ–π HTML) -->
  </div>
  <!-- (–æ—Å—Ç–∞–ª—å–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã UI) -->

  <script>
    // (–≤–∞—à –ø—Ä–µ–¥—ã–¥—É—â–∏–π JavaScript) ------------------------------------

    // --- –ù–û–í–´–ô –ö–û–î –î–õ–Ø 3D ---
    function init3DAnimation() {
      const container = document.getElementById('preview3d');
      if (!container) return;

      const scene = new THREE.Scene();
      const camera = new THREE.PerspectiveCamera(75, container.clientWidth / 180, 0.1, 1000);
      const renderer = new THREE.WebGLRenderer({ alpha: true });
      renderer.setSize(container.clientWidth, 180);
      container.innerHTML = '';
      container.appendChild(renderer.domElement);

      const light = new THREE.AmbientLight(0xffffff, 1);
      scene.add(light);

      const loader = new THREE.GLTFLoader();
      loader.load('model.glb', (gltf) => {
        scene.add(gltf.scene);
        animate();
      }, undefined, (error) => {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ 3D-–º–æ–¥–µ–ª–∏:', error);
        // –ó–∞–≥–ª—É—à–∫–∞
        const geometry = new THREE.TorusKnotGeometry(0.8, 0.3, 100, 16);
        const material = new THREE.MeshPhongMaterial({ color: 0x0077ff });
        const shape = new THREE.Mesh(geometry, material);
        scene.add(shape);
        animate();
      });

      camera.position.z = 3;

      function animate() {
        requestAnimationFrame(animate);
        if (scene.children.find(c => c.isObject3D)) {
          scene.children.find(c => c.isObject3D).rotation.x += 0.01;
          scene.children.find(c => c.isObject3D).rotation.y += 0.01;
        }
        renderer.render(scene, camera);
      }

      window.addEventListener('resize', () => {
        renderer.setSize(container.clientWidth, 180);
        camera.aspect = container.clientWidth / 180;
        camera.updateProjectionMatrix();
      });
    }

    // --- –ù–û–í–´–ô –ö–û–î –î–õ–Ø Google Drive ---
    let gapiLoaded = false;
    let isSignedIn = false;

    function initGoogleDrive() {
      gapi.load('client:auth2', () => {
        gapiLoaded = true;
        gapi.client.init({
          apiKey: 'YOUR_BROWSER_API_KEY',
          clientId: 'YOUR_CLIENT_ID',
          discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'],
          scope: 'https://www.googleapis.com/auth/drive.file'
        }).then(() => {
          const authInstance = gapi.auth2.getAuthInstance();
          authInstance.isSignedIn.listen(updateSignInStatus);
          updateSignInStatus(authInstance.isSignedIn.get());
        });
      });
    }

    function updateSignInStatus(isSignedInState) {
      isSignedIn = isSignedInState;
      if (isSignedInState) {
        showToast("‚úÖ –í—Ö–æ–¥ –≤ Google –≤—ã–ø–æ–ª–Ω–µ–Ω");
      }
    }

    function syncBookmarksToDrive() {
      if (!isSignedIn) {
        showToast("‚ùå –°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ Google");
        return;
      }
      const bookmarks = JSON.parse(localStorage.getItem('dzenBookmarks') || '[]');
      const content = JSON.stringify(bookmarks, null, 2);

      const boundary = 'dzenwikiboundary';
      const delimiter = "\r\n--" + boundary + "\r\n";
      const close_delim = "\r\n--" + boundary + "--";

      const metadata = {
        name: 'dzen-bookmarks.json',
        parents: ['appDataFolder']
      };

      const multipartRequestBody =
        delimiter +
        'Content-Type: application/json\r\n\r\n' +
        JSON.stringify(metadata) +
        delimiter +
        'Content-Type: application/json\r\n\r\n' +
        content +
        close_delim;

      gapi.client.request({
        path: '/upload/drive/v3/files',
        method: 'POST',
        params: { uploadType: 'multipart' },
        headers: { 'Content-Type': 'multipart/related; boundary="' + boundary + '"' },
        body: multipartRequestBody
      }).then(() => showToast("üíæ –ó–∞–∫–ª–∞–¥–∫–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã"));
    }

    // --- –í–°–¢–†–ê–ò–í–ê–ù–ò–ï –í –ò–ù–¢–ï–†–§–ï–ô–° ---
    function initDzen() {
      // ... –≤–∞—à –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∫–æ–¥ ...

      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è 3D
      init3DAnimation();

      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Google Drive
      initGoogleDrive();

      // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
      const syncBtn = document.createElement('button');
      syncBtn.className = 'btn';
      syncBtn.innerHTML = '<i class="fas fa-sync-alt"></i> –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å';
      syncBtn.onclick = syncBookmarksToDrive;
      document.getElementById('dzenControls').appendChild(syncBtn);
    }

    // --- PWA Registration ---
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/service-worker.js');
      });
    }

    // --- –ó–∞–ø—É—Å–∫ ---
    init();
  </script>
</body>
</html>