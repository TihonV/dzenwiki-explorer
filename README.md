<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <!-- === SEO –∏ Open Graph === -->
  <title>üååüìö DzenWiki Explorer ‚Äî –ü–æ–∏—Å–∫ –≤–∏–¥–µ–æ –∏ —Å—Ç–∞—Ç–µ–π –±–µ–∑ –ì–î–ó</title>
  <meta name="description" content="DzenWiki Explorer ‚Äî –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞ –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—ã—Ö –≤–∏–¥–µ–æ –≤ –î–∑–µ–Ω–µ –∏ —Å—Ç–∞—Ç–µ–π –≤ –í–∏–∫–∏–ø–µ–¥–∏–∏. –ë–µ–∑ –ì–î–ó, —Å AI-—á–∞—Ç–æ–º, —Ñ–æ—Ä–º—É–ª–∞–º–∏, 3D-–∞–Ω–∏–º–∞—Ü–∏—è–º–∏ –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–µ–π –∑–∞–∫–ª–∞–¥–æ–∫." />
  <meta name="keywords" content="–¥–∑–µ–Ω, –≤–∏–∫–∏–ø–µ–¥–∏—è, –ø–æ–∏—Å–∫ –≤–∏–¥–µ–æ, –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ, –≥–¥–∑ –∑–∞–ø—Ä–µ—â–µ–Ω–æ, ai —á–∞—Ç, —Ñ–æ—Ä–º—É–ª—ã, 3d, —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è, –∑–∞–∫–ª–∞–¥–∫–∏" />
  <meta name="author" content="DzenWiki Explorer" />
  <meta name="robots" content="index, follow" />

  <!-- === Open Graph / Facebook / –í–∫–æ–Ω—Ç–∞–∫—Ç–µ === -->
  <meta property="og:title" content="DzenWiki Explorer ‚Äî –ü–æ–∏—Å–∫ –≤–∏–¥–µ–æ –∏ —Å—Ç–∞—Ç–µ–π –±–µ–∑ –ì–î–ó" />
  <meta property="og:description" content="–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞ –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—ã—Ö –≤–∏–¥–µ–æ –≤ –î–∑–µ–Ω–µ –∏ —Å—Ç–∞—Ç–µ–π –≤ –í–∏–∫–∏–ø–µ–¥–∏–∏. –ë–µ–∑ –ì–î–ó, —Å AI-—á–∞—Ç–æ–º, —Ñ–æ—Ä–º—É–ª–∞–º–∏, 3D-–∞–Ω–∏–º–∞—Ü–∏—è–º–∏." />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://yourusername.github.io/dzenwiki-explorer/" />
  <meta property="og:image" content="https://yourusername.github.io/dzenwiki-explorer/og-image.jpg" /> <!-- –ó–∞–≥—Ä—É–∑–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ —Ä–µ–ø–æ -->
  <meta property="og:locale" content="ru_RU" />

  <!-- === Twitter Card === -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="DzenWiki Explorer" />
  <meta name="twitter:description" content="–ü–æ–∏—Å–∫ –≤–∏–¥–µ–æ –∏ —Å—Ç–∞—Ç–µ–π –±–µ–∑ –ì–î–ó. AI, 3D, –∑–∞–∫–ª–∞–¥–∫–∏." />
  <meta name="twitter:image" content="https://yourusername.github.io/dzenwiki-explorer/og-image.jpg" />

  <!-- === Schema.org === -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebApplication",
    "name": "DzenWiki Explorer",
    "description": "–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞ –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—ã—Ö –≤–∏–¥–µ–æ –≤ –î–∑–µ–Ω–µ –∏ —Å—Ç–∞—Ç–µ–π –≤ –í–∏–∫–∏–ø–µ–¥–∏–∏.",
    "url": "https://yourusername.github.io/dzenwiki-explorer/",
    "applicationCategory": "EducationApplication",
    "operatingSystem": "Web Browser",
    "offers": {
      "@type": "Offer",
      "price": "0"
    }
  }
  </script>

  <!-- === PWA === -->
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="icon-192.png">
  <link rel="apple-touch-icon" href="icon-192.png">

  <!-- === –°—Ç–∏–ª–∏ === -->
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  
  <!-- === MathJax === -->
  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
</head>
<body class="mode-dzen">
  <div class="container">
    <header>
      <div class="logo" id="logo"><i class="fas fa-blog"></i> Dzen Explorer</div>
      <div class="controls" id="dzenControls">
        <button class="btn" id="toggleModeBtn"><i class="fas fa-exchange-alt"></i> –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ä–µ–∂–∏–º</button>
        <button class="btn" id="hideBtn"><i class="fas fa-user-secret"></i> –°–∫—Ä—ã—Ç—å</button>
      </div>
    </header>

    <!-- ========== –†–ï–ñ–ò–ú –î–ó–ï–ù ========== -->
    <div id="dzenMode">
      <section class="search-area">
        <div class="search-box">
          <input type="text" id="searchInput" placeholder="–ü–æ–∏—Å–∫ –≤–∏–¥–µ–æ –∏ –ø–æ—Å—Ç–æ–≤ –≤ –î–∑–µ–Ω–µ..." autofocus />
          <button class="btn" id="searchBtn"><i class="fas fa-search"></i> –ù–∞–π—Ç–∏</button>
          <button class="btn" id="voiceBtn"><i class="fas fa-microphone"></i> –ì–æ–ª–æ—Å</button>
        </div>
        <div class="suggestions" id="dzenSuggestions"></div>
      </section>

      <div id="resultsLoader" class="loader">–í–≤–µ–¥–∏—Ç–µ –∑–∞–ø—Ä–æ—Å...</div>
      <div class="video-grid" id="videoGrid"></div>

      <div style="margin-top: 20px;">
        <h3>AI-–ü–æ–º–æ—â–Ω–∏–∫</h3>
        <div id="aiChat">
          <div id="chatMessages">
            <div class="message ai-msg">–ü—Ä–∏–≤–µ—Ç! –Ø –ø–æ–º–æ–≥—É –Ω–∞–π—Ç–∏ –Ω—É–∂–Ω–æ–µ –≤–∏–¥–µ–æ –∏–ª–∏ –æ–±—ä—è—Å–Ω–∏—Ç—å —Ñ–æ—Ä–º—É–ª—É.</div>
          </div>
          <div id="chatInputBox">
            <input type="text" id="chatInput" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: ¬´–ö–∞–∫ —Ä–µ—à–∏—Ç—å x¬≤ + 5x + 6 = 0¬ª" />
            <button class="btn" id="sendChatBtn"><i class="fas fa-paper-plane"></i></button>
          </div>
        </div>
      </div>

      <div style="margin-top: 20px;">
        <h3>3D –ê–Ω–∏–º–∞—Ü–∏—è</h3>
        <div id="preview3d"></div>
      </div>
    </div>

    <!-- ========== –†–ï–ñ–ò–ú –í–ò–ö–ò–ü–ï–î–ò–Ø ========== -->
    <div id="wikiMode">
      <section class="search-area">
        <div class="search-box">
          <input type="text" id="wikiSearchInput" placeholder="–ü–æ–∏—Å–∫ –≤ –í–∏–∫–∏–ø–µ–¥–∏–∏..." />
          <button class="btn" id="wikiSearchBtn"><i class="fas fa-search"></i> –ù–∞–π—Ç–∏</button>
        </div>
        <div class="suggestions" id="wikiSuggestions"></div>
      </section>

      <div id="wikiContent">
        <div class="loader">–í–≤–µ–¥–∏—Ç–µ –∑–∞–ø—Ä–æ—Å –≤ –í–∏–∫–∏–ø–µ–¥–∏—é</div>
      </div>

      <div style="display: flex; gap: 15px; margin-top: 20px; flex-wrap: wrap;">
        <button class="btn accent" id="exportPDF"><i class="fas fa-file-pdf"></i> –≠–∫—Å–ø–æ—Ä—Ç –≤ PDF</button>
        <button class="btn" id="exportMD"><i class="fas fa-file-code"></i> –≠–∫—Å–ø–æ—Ä—Ç –≤ Markdown</button>
        <button class="btn" id="readAloud"><i class="fas fa-volume-up"></i> –û–∑–≤—É—á–∏—Ç—å —Ç–µ–∫—Å—Ç</button>
      </div>
    </div>
  </div>

  <div id="hiddenMode">
    <h2>üéÆ –†–µ–∂–∏–º —Å–∫—Ä—ã—Ç–Ω–æ—Å—Ç–∏</h2>
    <p>–í–≤–µ–¥–∏—Ç–µ –ª—é–±–æ–π —Ç–µ–∫—Å—Ç, —á—Ç–æ–±—ã –≤–µ—Ä–Ω—É—Ç—å—Å—è</p>
    <input type="text" id="gameInput" placeholder="..." />
    <button class="btn" id="gameSubmitBtn">–í–µ—Ä–Ω—É—Ç—å—Å—è</button>
  </div>

  <div class="toast" id="toast">–ì–æ—Ç–æ–≤–æ!</div>

  <!-- === –°–∫—Ä–∏–ø—Ç—ã === -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.min.js"></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://apis.google.com/js/api.js" async defer></script>

  <script>
    // === –ì–ª–æ–±–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ ===
    let currentMode = localStorage.getItem('dzenwiki_mode') || 'dzen';
    let dzenHistory = JSON.parse(localStorage.getItem('dzen_history') || '[]');
    let wikiHistory = JSON.parse(localStorage.getItem('wiki_history') || '[]');

    // === –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ===
    function init() {
      document.body.className = `mode-${currentMode}`;
      updateLogo();
      showCurrentMode();

      if (currentMode === 'dzen') {
        initDzen();
      } else {
        initWiki();
      }
    }

    function showCurrentMode() {
      document.getElementById('dzenMode').style.display = currentMode === 'dzen' ? 'block' : 'none';
      document.getElementById('wikiMode').style.display = currentMode === 'wiki' ? 'block' : 'none';
    }

    function updateLogo() {
      const logo = document.getElementById('logo');
      logo.innerHTML = currentMode === 'dzen'
        ? '<i class="fas fa-blog"></i> Dzen Explorer'
        : '<i class="fas fa-book"></i> Wikipedia Explorer';
    }

    // === –ü–ï–†–ï–ö–õ–Æ–ß–ï–ù–ò–ï –†–ï–ñ–ò–ú–û–í ===
    document.getElementById('toggleModeBtn').addEventListener('click', () => {
      currentMode = currentMode === 'dzen' ? 'wiki' : 'dzen';
      localStorage.setItem('dzenwiki_mode', currentMode);
      init();
    });

    // === –†–ï–ñ–ò–ú –î–ó–ï–ù ===
    function initDzen() {
      updateDzenSuggestions();

      document.getElementById('searchBtn').onclick = () => {
        const q = document.getElementById('searchInput').value.trim();
        if (q) performDzenSearch(q);
      };

      document.getElementById('searchInput').addEventListener('keypress', e => {
        if (e.key === 'Enter') {
          const q = document.getElementById('searchInput').value.trim();
          if (q) performDzenSearch(q);
        }
      });

      // –ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥
      if ('SpeechRecognition' in window || 'webkitSpeechRecognition' in window) {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const recognition = new SpeechRecognition();
        recognition.lang = 'ru-RU';
        document.getElementById('voiceBtn').onclick = () => recognition.start();
        recognition.onresult = e => {
          const transcript = e.results[0][0].transcript;
          document.getElementById('searchInput').value = transcript;
          performDzenSearch(transcript);
        };
      } else {
        document.getElementById('voiceBtn').remove();
      }

      initAIChat();
      init3DAnimation();
      initGoogleDrive();

      // –ö–Ω–æ–ø–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
      const syncBtn = document.createElement('button');
      syncBtn.className = 'btn';
      syncBtn.innerHTML = '<i class="fas fa-sync-alt"></i> –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å';
      syncBtn.onclick = syncBookmarksToDrive;
      document.getElementById('dzenControls').appendChild(syncBtn);
    }

    async function performDzenSearch(query) {
      // –§–∏–ª—å—Ç—Ä –ì–î–ó
      const gdzWords = ['–≥–¥–∑', '—Ä–µ—à–µ–±–Ω–∏–∫', '–æ—Ç–≤–µ—Ç—ã', '–¥–æ–º–∞—à–∫–∞'];
      if (gdzWords.some(w => query.toLowerCase().includes(w))) {
        showToast("üö´ –ü–æ–∏—Å–∫ –ì–î–ó –∑–∞–ø—Ä–µ—â—ë–Ω");
        return;
      }

      // –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –Ω–æ–º–µ—Ä–∞ –∑–∞–¥–∞—á–∏
      const numMatch = query.match(/\b(\d{1,4})\b/);
      if (numMatch) {
        const num = numMatch[1];
        const base = query.replace(numMatch[0], '').trim();
        query = `${base} —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ ${num}`;
        showToast(`üîç –£—Ç–æ—á–Ω—ë–Ω–Ω–æ: "${query}"`);
      }

      saveToHistory('dzen', query);
      updateDzenSuggestions();

      const loader = document.getElementById('resultsLoader');
      loader.textContent = '–ü–æ–∏—Å–∫...';
      document.getElementById('videoGrid').innerHTML = '';

      // –≠–º—É–ª—è—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
      const mockResults = [
        { title: `"${query}" ‚Äî –ø–æ–¥—Ä–æ–±–Ω—ã–π —Ä–∞–∑–±–æ—Ä`, author: "–û–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—ã–π –∫–∞–Ω–∞–ª", thumb: "https://via.placeholder.com/320x180/1e1e1e/0077ff?text=–í–∏–¥–µ–æ+1" },
        { title: `–ö–∞–∫ —Ä–µ—à–∞—Ç—å –∑–∞–¥–∞—á–∏ –ø–æ ${query}`, author: "–£—á—ë–Ω—ã–π –ö–æ—Ç", thumb: "https://via.placeholder.com/320x180/1e1e1e/bb86fc?text=–í–∏–¥–µ–æ+2" },
        { title: `–õ–∞–π—Ñ—Ö–∞–∫–∏ –¥–ª—è –ø–æ–Ω–∏–º–∞–Ω–∏—è ${query}`, author: "SmartStudy", thumb: "https://via.placeholder.com/320x180/1e1e1e/0077ff?text=–í–∏–¥–µ–æ+3" }
      ];

      const grid = document.getElementById('videoGrid');
      mockResults.forEach(video => {
        const card = document.createElement('div');
        card.className = 'video-card';
        card.innerHTML = `
          <img src="${video.thumb}" alt="" class="video-thumb">
          <div class="video-info">
            <div class="video-title">${video.title}</div>
            <div class="video-author">${video.author}</div>
          </div>
        `;
        card.onclick = () => {
          document.getElementById('searchInput').value = video.title;
          performDzenSearch(video.title);
        };
        grid.appendChild(card);
      });

      loader.textContent = '';
    }

    function saveToHistory(type, item) {
      const list = type === 'dzen' ? dzenHistory : wikiHistory;
      if (!list.includes(item)) {
        list.unshift(item);
        if (list.length > 30) list.pop();
        localStorage.setItem(`${type}_history`, JSON.stringify(list));
      }
    }

    function updateDzenSuggestions() {
      const box = document.getElementById('dzenSuggestions');
      box.innerHTML = '';
      dzenHistory.slice(0, 5).forEach(q => {
        const tag = createSuggestionTag(q, () => {
          document.getElementById('searchInput').value = q;
          performDzenSearch(q);
        });
        box.appendChild(tag);
      });
    }

    // === –ß–ê–¢ –° –ú–ê–¢–ï–ú–ê–¢–ò–ö–û–ô ===
    function initAIChat() {
      const chatInput = document.getElementById('chatInput');
      const chatMessages = document.getElementById('chatMessages');

      document.getElementById('sendChatBtn').onclick = sendChat;
      chatInput.addEventListener('keypress', e => e.key === 'Enter' && sendChat());

      function sendChat() {
        const msg = chatInput.value.trim();
        if (!msg) return;
        addMessage(msg, 'user');
        chatInput.value = '';

        setTimeout(() => {
          let reply = getAIResponse(msg);
          addMessage(reply, 'ai');
          MathJax.typesetPromise([chatMessages.lastElementChild]).catch(console.error);
        }, 600);
      }

      function addMessage(text, sender) {
        const div = document.createElement('div');
        div.className = `message ${sender === 'user' ? 'user-msg' : 'ai-msg'}`;
        div.textContent = text;
        chatMessages.appendChild(div);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      function getAIResponse(msg) {
        msg = msg.toLowerCase();
        if (msg.includes('—Ñ–æ—Ä–º—É–ª–∞')) return "–§–æ—Ä–º—É–ª—ã –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è: $E = mc^2$, $\\int x dx$";
        if (msg.includes('x¬≤') || msg.includes('–∫–≤–∞–¥—Ä–∞—Ç–Ω–æ–µ')) return "–†–µ—à–∞–π—Ç–µ —á–µ—Ä–µ–∑ –¥–∏—Å–∫—Ä–∏–º–∏–Ω–∞–Ω—Ç: $D = b^2 - 4ac$";
        if (msg.includes('–≥–¥–∑')) return "–Ø –Ω–µ –ø–æ–º–æ–≥–∞—é —Å –ì–î–ó. –ù–æ –º–æ–≥—É –æ–±—ä—è—Å–Ω–∏—Ç—å —Ç–µ–º—É!";
        return "–Ø –ø–æ–º–æ–≥–∞—é —Å —É—á–µ–±–æ–π –±–µ–∑ –ì–î–ó. –ó–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å –ø–æ —Ç–µ–º–µ.";
      }
    }

    // === 3D –ê–ù–ò–ú–ê–¶–ò–Ø ===
    function init3DAnimation() {
      const container = document.getElementById('preview3d');
      if (!container) return;

      const scene = new THREE.Scene();
      const camera = new THREE.PerspectiveCamera(75, container.clientWidth / 180, 0.1, 1000);
      const renderer = new THREE.WebGLRenderer({ alpha: true });
      renderer.setSize(container.clientWidth, 180);
      container.innerHTML = '';
      container.appendChild(renderer.domElement);

      const light = new THREE.AmbientLight(0xffffff, 1);
      scene.add(light);

      const loader = new THREE.GLTFLoader();
      loader.load('model.glb', (gltf) => {
        scene.add(gltf.scene);
        animate();
      }, undefined, (error) => {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ 3D-–º–æ–¥–µ–ª–∏:', error);
        // –ó–∞–≥–ª—É—à–∫–∞
        const geometry = new THREE.TorusKnotGeometry(0.8, 0.3, 100, 16);
        const material = new THREE.MeshPhongMaterial({ color: 0x0077ff });
        const shape = new THREE.Mesh(geometry, material);
        scene.add(shape);
        animate();
      });

      camera.position.z = 3;

      function animate() {
        requestAnimationFrame(animate);
        if (scene.children.find(c => c.isObject3D)) {
          scene.children.find(c => c.isObject3D).rotation.x += 0.01;
          scene.children.find(c => c.isObject3D).rotation.y += 0.01;
        }
        renderer.render(scene, camera);
      }

      window.addEventListener('resize', () => {
        renderer.setSize(container.clientWidth, 180);
        camera.aspect = container.clientWidth / 180;
        camera.updateProjectionMatrix();
      });
    }

    // === GOOGLE DRIVE SYNC ===
    let gapiLoaded = false;
    let isSignedIn = false;

    function initGoogleDrive() {
      gapi.load('client:auth2', () => {
        gapiLoaded = true;
        gapi.client.init({
          apiKey: 'YOUR_BROWSER_API_KEY',
          clientId: 'YOUR_CLIENT_ID',
          discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'],
          scope: 'https://www.googleapis.com/auth/drive.file'
        }).then(() => {
          const authInstance = gapi.auth2.getAuthInstance();
          authInstance.isSignedIn.listen(updateSignInStatus);
          updateSignInStatus(authInstance.isSignedIn.get());
        });
      });
    }

    function updateSignInStatus(isSignedInState) {
      isSignedIn = isSignedInState;
      if (isSignedInState) {
        showToast("‚úÖ –í—Ö–æ–¥ –≤ Google –≤—ã–ø–æ–ª–Ω–µ–Ω");
      }
    }

    function syncBookmarksToDrive() {
      if (!isSignedIn) {
        showToast("‚ùå –°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ Google");
        return;
      }
      const bookmarks = JSON.parse(localStorage.getItem('dzenBookmarks') || '[]');
      const content = JSON.stringify(bookmarks, null, 2);

      const boundary = 'dzenwikiboundary';
      const delimiter = "\r\n--" + boundary + "\r\n";
      const close_delim = "\r\n--" + boundary + "--";

      const metadata = {
        name: 'dzen-bookmarks.json',
        parents: ['appDataFolder']
      };

      const multipartRequestBody =
        delimiter +
        'Content-Type: application/json\r\n\r\n' +
        JSON.stringify(metadata) +
        delimiter +
        'Content-Type: application/json\r\n\r\n' +
        content +
        close_delim;

      gapi.client.request({
        path: '/upload/drive/v3/files',
        method: 'POST',
        params: { uploadType: 'multipart' },
        headers: { 'Content-Type': 'multipart/related; boundary="' + boundary + '"' },
        body: multipartRequestBody
      }).then(() => showToast("üíæ –ó–∞–∫–ª–∞–¥–∫–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã"));
    }

    // === –†–ï–ñ–ò–ú –í–ò–ö–ò–ü–ï–î–ò–Ø ===
    function initWiki() {
      updateWikiSuggestions();

      document.getElementById('wikiSearchBtn').onclick = () => {
        const q = document.getElementById('wikiSearchInput').value.trim();
        if (q) performWikiSearch(q);
      };

      document.getElementById('wikiSearchInput').addEventListener('keypress', e => {
        if (e.key === 'Enter') {
          const q = document.getElementById('wikiSearchInput').value.trim();
          if (q) performWikiSearch(q);
        }
      });

      document.getElementById('exportMD').onclick = exportMarkdown;
      document.getElementById('exportPDF').onclick = () => window.print();
      document.getElementById('readAloud').onclick = readAloud;
    }

    async function performWikiSearch(query) {
      saveToHistory('wiki', query);
      updateWikiSuggestions();

      const contentDiv = document.getElementById('wikiContent');
      contentDiv.innerHTML = '<div class="loader">–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç—å–∏...</div>';

      try {
        const response = await fetch(`https://ru.wikipedia.org/api/rest_v1/page/html/${encodeURIComponent(query)}`);
        if (!response.ok) throw new Error("–°—Ç–∞—Ç—å—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞");

        const html = await response.text();
        contentDiv.innerHTML = html;

        document.querySelectorAll('#wikiContent .mwe-popups, #wikiContent .vector-page-toolbar').forEach(el => el.remove());

        document.querySelectorAll('#wikiContent img').forEach(img => {
          if (img.src.startsWith('//')) img.src = 'https:' + img.src;
        });

        document.querySelectorAll('#wikiContent a').forEach(a => {
          if (a.href.includes('wikipedia.org')) {
            a.onclick = (e) => {
              e.preventDefault();
              const title = a.href.split('/').pop();
              performWikiSearch(decodeURIComponent(title));
            };
          }
        });

        MathJax.typesetPromise([contentDiv]).catch(console.error);
      } catch (err) {
        contentDiv.innerHTML = `<div class="loader">‚ùå –°—Ç–∞—Ç—å—è "${query}" –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ.</div>`;
      }
    }

    function exportMarkdown() {
      const content = document.getElementById('wikiContent').innerText;
      const blob = new Blob([`# ${document.getElementById('wikiSearchInput').value}\n\n${content}`], { type: 'text/markdown' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'article.md';
      a.click();
    }

    function readAloud() {
      const text = document.getElementById('wikiContent').innerText;
      if ('speechSynthesis' in window) {
        const utterance = new SpeechSynthesisUtterance(text.substring(0, 500));
        utterance.lang = 'ru-RU';
        speechSynthesis.speak(utterance);
      } else {
        alert("–°–∏–Ω—Ç–µ–∑ —Ä–µ—á–∏ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ.");
      }
    }

    function updateWikiSuggestions() {
      const box = document.getElementById('wikiSuggestions');
      box.innerHTML = '';
      wikiHistory.slice(0, 5).forEach(q => {
        const tag = createSuggestionTag(q, () => {
          document.getElementById('wikiSearchInput').value = q;
          performWikiSearch(q);
        });
        box.appendChild(tag);
      });
    }

    // === –£—Ç–∏–ª–∏—Ç—ã ===
    function createSuggestionTag(text, onClick) {
      const tag = document.createElement('div');
      tag.className = 'suggestion-tag';
      tag.textContent = text;
      tag.onclick = onClick;
      return tag;
    }

    // === –°–ö–†–´–¢–ò–ï ===
    document.getElementById('hideBtn').addEventListener('click', () => {
      document.querySelector('.container').style.display = 'none';
      document.getElementById('hiddenMode').style.display = 'flex';
    });

    document.getElementById('gameSubmitBtn').addEventListener('click', () => {
      document.querySelector('.container').style.display = 'block';
      document.getElementById('hiddenMode').style.display = 'none';
    });

    // === TOAST ===
    function showToast(msg) {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.classList.add('show');
      setTimeout(() => t.classList.remove('show'), 3000);
    }

    // === PWA Registration ===
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('service-worker.js');
      });
    }

    // === –ó–ê–ü–£–°–ö ===
    init();
  </script>
</body>
</html>
